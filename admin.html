<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - RoK DKP Tracker</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="admin-body">
    <div id="adminApp">
        <header class="admin-header">
            <div class="header-content">
                <h1>üè∞ KvK DKP Tracker - ADMIN MODE</h1>
                <div class="admin-controls">
                    <span class="admin-status">Admin: Active</span>
                    <button id="logoutBtn" class="logout-btn">Logout</button>
                </div>
            </div>
        </header>

        <nav class="admin-nav">
            <button class="nav-btn active" data-view="map">üó∫Ô∏è Upload Data</button>
            <button class="nav-btn" data-view="rankings">üìä View Rankings</button>
            <button class="nav-btn" data-view="analytics">üìà Analytics</button>
            <button class="nav-btn" data-view="manage">‚öôÔ∏è Manage</button>
        </nav>

        <main class="admin-content">
            <div id="mapView" class="view-panel active">
                <h2>Interactive Map - Click KD to Upload</h2>
                <div class="map-instructions">
                    <p>‚Ä¢ Click any KD number on the map to upload CSV data</p>
                    <p>‚Ä¢ Green = Data uploaded | Red = Missing data | Yellow = Partial data</p>
                </div>
                
                <div class="map-container">
                    <img src="assets/KvKMap.png" alt="KvK Map" class="interactive-map">
                    
                    <!-- Responsive KD Labels Overlay - Organic City-like Distribution -->
                    <div class="kd-labels-responsive">
                        <!-- Fire Camp KDs (top-left) - Clustered Settlement Pattern -->
                        <div class="kd-label fire" style="left: 10.5%; top: 19.8%; transform: translate(-50%, -50%) rotate(-2deg);" data-kd="1400" data-camp="Fire">1400</div>
                        <div class="kd-label fire" style="left: 15.8%; top: 22.7%; transform: translate(-50%, -50%) rotate(1deg);" data-kd="1068" data-camp="Fire">1068</div>
                        <div class="kd-label fire" style="left: 21.3%; top: 20.4%; transform: translate(-50%, -50%) rotate(-1deg);" data-kd="1471" data-camp="Fire">1471</div>
                        <div class="kd-label fire" style="left: 18.9%; top: 25.8%; transform: translate(-50%, -50%) rotate(2deg);" data-kd="2162" data-camp="Fire">2162</div>
                        <div class="kd-label fire" style="left: 26.2%; top: 23.1%; transform: translate(-50%, -50%) rotate(-3deg);" data-kd="2197" data-camp="Fire">2197</div>
                        <div class="kd-label fire" style="left: 13.4%; top: 26.3%; transform: translate(-50%, -50%) rotate(1.5deg);" data-kd="1520" data-camp="Fire">1520</div>
                        
                        <!-- Earth Camp KDs (top-right) - Mountain Settlement Pattern -->
                        <div class="kd-label earth" style="left: 71.2%; top: 20.4%; transform: translate(-50%, -50%) rotate(2deg);" data-kd="1244" data-camp="Earth">1244</div>
                        <div class="kd-label earth" style="left: 76.8%; top: 23.2%; transform: translate(-50%, -50%) rotate(-1.5deg);" data-kd="1694" data-camp="Earth">1694</div>
                        <div class="kd-label earth" style="left: 82.3%; top: 19.7%; transform: translate(-50%, -50%) rotate(1deg);" data-kd="2944" data-camp="Earth">2944</div>
                        <div class="kd-label earth" style="left: 85.7%; top: 24.8%; transform: translate(-50%, -50%) rotate(-2deg);" data-kd="3590" data-camp="Earth">3590</div>
                        <div class="kd-label earth" style="left: 70.5%; top: 29.9%; transform: translate(-50%, -50%) rotate(3deg);" data-kd="2546" data-camp="Earth">2546</div>
                        <div class="kd-label earth" style="left: 79.4%; top: 35.3%; transform: translate(-50%, -50%) rotate(-1deg);" data-kd="1014" data-camp="Earth">1014</div>
                        
                        <!-- Water Camp KDs (bottom-left) - Coastal Settlement Pattern -->
                        <div class="kd-label water" style="left: 9.8%; top: 74.2%; transform: translate(-50%, -50%) rotate(-2deg);" data-kd="3554" data-camp="Water">3554</div>
                        <div class="kd-label water" style="left: 15.3%; top: 76.8%; transform: translate(-50%, -50%) rotate(1.5deg);" data-kd="1896" data-camp="Water">1896</div>
                        <div class="kd-label water" style="left: 20.7%; top: 73.9%; transform: translate(-50%, -50%) rotate(-1deg);" data-kd="1569" data-camp="Water">1569</div>
                        <div class="kd-label water" style="left: 17.4%; top: 89.6%; transform: translate(-50%, -50%) rotate(2deg);" data-kd="3152" data-camp="Water">3152</div>
                        <div class="kd-label water" style="left: 25.8%; top: 77.1%; transform: translate(-50%, -50%) rotate(-2.5deg);" data-kd="3596" data-camp="Water">3596</div>
                        <div class="kd-label water" style="left: 9.6%; top: 85.4%; transform: translate(-50%, -50%) rotate(1deg);" data-kd="2711" data-camp="Water">2711</div>
                        <div class="kd-label water" style="left: 22.3%; top: 81.2%; transform: translate(-50%, -50%) rotate(-1.5deg);" data-kd="1267" data-camp="Water">1267</div>
                        
                        <!-- Wind Camp KDs (bottom-right) - Windswept Highland Pattern -->
                        <div class="kd-label wind" style="left: 70.3%; top: 72.4%; transform: translate(-50%, -50%) rotate(2.5deg);" data-kd="2352" data-camp="Wind">2352</div>
                        <div class="kd-label wind" style="left: 75.8%; top: 74.9%; transform: translate(-50%, -50%) rotate(-1deg);" data-kd="2973" data-camp="Wind">2973</div>
                        <div class="kd-label wind" style="left: 81.2%; top: 71.8%; transform: translate(-50%, -50%) rotate(1.5deg);" data-kd="1477" data-camp="Wind">1477</div>
                        <div class="kd-label wind" style="left: 84.6%; top: 76.3%; transform: translate(-50%, -50%) rotate(-2deg);" data-kd="1294" data-camp="Wind">1294</div>
                        <div class="kd-label wind" style="left: 87.9%; top: 73.1%; transform: translate(-50%, -50%) rotate(3deg);" data-kd="1732" data-camp="Wind">1732</div>
                        <div class="kd-label wind" style="left: 72.7%; top: 78.2%; transform: translate(-50%, -50%) rotate(-1.5deg);" data-kd="2509" data-camp="Wind">2509</div>
                        <div class="kd-label wind" style="left: 78.3%; top: 79.8%; transform: translate(-50%, -50%) rotate(2deg);" data-kd="1359" data-camp="Wind">1359</div>
                    </div>
                </div>
            </div>

            <div id="rankingsView" class="view-panel">
                <h2>Kingdom Rankings</h2>
                <div class="rankings-controls">
                    <select id="rankingsEventFilter" class="form-select" style="width: auto; display: inline-block;">
                        <option value="cumulative">All Events (Cumulative)</option>
                        <option value="Pass 4*">Pass 4*</option>
                        <option value="Altar of darkness">Altar of darkness</option>
                        <option value="Pass 7">Pass 7</option>
                        <option value="Pass 8">Pass 8</option>
                        <option value="Great ziggurat">Great ziggurat</option>
                    </select>
                    <button id="refreshRankings" class="btn-secondary" style="margin-left: 10px;">Refresh</button>
                </div>
                <div class="table-container" style="margin-top: 20px;">
                    <table class="data-table" id="rankingsTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Kingdom</th>
                                <th>Camp</th>
                                <th>Total DKP</th>
                                <th>Kill Points</th>
                                <th>T5 Kills</th>
                                <th>T4 Kills</th>
                                <th>Deaths</th>
                                <th>Healed</th>
                                <th>Players</th>
                            </tr>
                        </thead>
                        <tbody id="rankingsTableBody">
                            <!-- Rankings will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="analyticsView" class="view-panel">
                <h2>Analytics Dashboard</h2>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>Upload Status</h3>
                        <canvas id="uploadStatusChart"></canvas>
                    </div>
                    <div class="analytics-card">
                        <h3>DKP Trends</h3>
                        <canvas id="dkpTrendsChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="manageView" class="view-panel">
                <h2>Data Management</h2>
                <div class="manage-actions">
                    <button class="btn-secondary">Clear Event Data</button>
                    <button class="btn-danger">Reset Database</button>
                </div>
                <div class="manage-info">
                    <p><strong>Clear Event Data:</strong> Removes all uploaded event data and player statistics while keeping kingdom structure.</p>
                    <p><strong>Reset Database:</strong> Completely wipes all data including kingdoms, events, and aggregates. Use with extreme caution!</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content upload-modal">
            <span class="close">&times;</span>
            <h2>üìä Upload Stats for KD <span id="uploadKD"></span></h2>
            
            <div class="upload-form">
                <div class="form-group">
                    <label>Select Event:</label>
                    <select id="eventSelect" class="form-select">
                        <option value="">-- Select Event --</option>
                        <option value="Pass 4*">Pass 4* - Thu, 11.9, 7:04</option>
                        <option value="Altar of darkness">Altar of darkness - Tue, 23.9, 7:04</option>
                        <option value="Pass 7">Pass 7 - Fri, 3.10, 7:04</option>
                        <option value="Pass 8">Pass 8 - Mon, 6.10, 7:04</option>
                        <option value="Great ziggurat">Great ziggurat - Sun, 12.10, 7:04</option>
                    </select>
                </div>

                <div class="upload-zone-single">
                    <h3>Event Score Data</h3>
                    <p class="upload-instructions">Upload the Excel/CSV file containing the event scores (deltas already calculated)</p>
                    <div class="drop-area" id="eventDrop">
                        <p>üìÅ Drop Excel/CSV here or click to browse</p>
                        <input type="file" id="eventFile" accept=".xlsx,.xls,.csv" hidden>
                    </div>
                    <div class="upload-status" id="eventStatus"></div>
                </div>

                <div class="dkp-preview" id="dkpPreview" style="display: none;">
                    <h3>DKP Calculation Preview:</h3>
                    <div class="calculation-details">
                        <div>‚Ä¢ T5 Kills: <span id="t5Preview">0</span> √ó 10 = <span id="t5Points">0</span></div>
                        <div>‚Ä¢ T4 Kills: <span id="t4Preview">0</span> √ó 5 = <span id="t4Points">0</span></div>
                        <div>‚Ä¢ Deaths: <span id="deathsPreview">0</span> √ó 15 = <span id="deathPoints">0</span></div>
                        <div class="total-dkp">‚Ä¢ Total DKP: <span id="totalDKP">0</span></div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" id="calculateBtn" class="btn-primary" disabled>üìä Calculate & Save</button>
                    <button type="button" id="cancelUpload" class="btn-secondary">‚ùå Cancel</button>
                </div>
                <div class="upload-hint" id="uploadHint" style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em;">
                    ‚ÑπÔ∏è Select an event and upload a file to enable the save button
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <!-- SheetJS for Excel file parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- PapaParse for CSV (kept for backwards compatibility) -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Application Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/map-handler.js"></script>
    <script src="js/file-parser.js"></script>
    <script src="js/data-processor.js"></script>
    <script src="js/data-retriever.js"></script>
    <script src="js/admin.js"></script>
</body>
</html>